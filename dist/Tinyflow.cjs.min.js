"use strict";function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}var e=["name","id","steps"],n=["id","workflowId","name","data","next"];function r(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function o(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?r(Object(n),!0).forEach((function(e){i(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function i(t,e,n){return(e=m(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function a(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var r,o,i,a,u=[],c=!0,s=!1;try{if(i=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=i.call(n)).done)&&(u.push(r.value),u.length!==e);c=!0);}catch(t){s=!0,o=t}finally{try{if(!c&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(s)throw o}}return u}}(t,e)||g(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(t,e){if(null==t)return{};var n,r,o=function(t,e){if(null==t)return{};var n,r,o={},i=Object.keys(t);for(r=0;r<i.length;r++)n=i[r],e.indexOf(n)>=0||(o[n]=t[n]);return o}(t,e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(r=0;r<i.length;r++)n=i[r],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(o[n]=t[n])}return o}function c(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&h(t,e)}function s(e){var n=p();return function(){var r,o=y(e);if(n){var i=y(this).constructor;r=Reflect.construct(o,arguments,i)}else r=o.apply(this,arguments);return function(e,n){if(n&&("object"===t(n)||"function"==typeof n))return n;if(void 0!==n)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(e)}(this,r)}}function l(t){var e="function"==typeof Map?new Map:void 0;return l=function(t){if(null===t||!function(t){try{return-1!==Function.toString.call(t).indexOf("[native code]")}catch(e){return"function"==typeof t}}(t))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,n)}function n(){return f(t,arguments,y(this).constructor)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),h(n,t)},l(t)}function f(t,e,n){return f=p()?Reflect.construct.bind():function(t,e,n){var r=[null];r.push.apply(r,e);var o=new(Function.bind.apply(t,r));return n&&h(o,n.prototype),o},f.apply(null,arguments)}function p(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function h(t,e){return h=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},h(t,e)}function y(t){return y=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},y(t)}function d(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function v(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,m(r.key),r)}}function b(t,e,n){return e&&v(t.prototype,e),n&&v(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function m(e){var n=function(e,n){if("object"!==t(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var o=r.call(e,n||"default");if("object"!==t(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(e)}(e,"string");return"symbol"===t(n)?n:String(n)}function w(t){return function(t){if(Array.isArray(t))return O(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||g(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function g(t,e){if(t){if("string"==typeof t)return O(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?O(t,e):void 0}}function O(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var j={},k={extensions:new Map,instances:new Map,id:function(){return Math.random().toString(16).substring(2,16)},listeners:new WeakMap},S=k.extensions,x=k.listeners,P=k.instances;x.by=function(t,e){return x.has(t)||x.set(t,new Map),x.get(t).get(e)||[]},j.extend=function(t){return t(k)},j.get=function(t){return P.get(t)},j.all=function(){return w(P.values())},j.clear=function(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=function(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=g(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0,o=function(){};return{s:o,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,u=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return a=t.done,t},e:function(t){u=!0,i=t},f:function(){try{a||null==n.return||n.return()}finally{if(u)throw i}}}}(w(P.keys()));try{for(n.s();!(t=n.n()).done;){var r=t.value;j.get(r).cancel(),j.dispose(r)}}catch(t){n.e(t)}finally{n.f()}e.extensions&&S.clear()},j.use=function(t,e){(null===e?S.delete:S.set).call(S,t,e)},j.create=function(t){var e=new M(t);return P.set(e.id,e),e},j.dispose=function(t){var e=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).force,n=void 0!==e&&e,r=P.get(t);if(!r)throw new A("Workflow does not exist by id ".concat(t));if(!n&&"active"===r.state)throw new A('Cannot dispose active workflow "'.concat(r.name,'"'),{instanceId:t});r.current&&(r.current.off(),r.current=null),r.off(),x.delete(r),P.delete(t)};var E=function(t){return setTimeout(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:0)},I=function(){function t(){d(this,t)}return b(t,[{key:"count",value:function(){return x.by(this,name).length}},{key:"on",value:function(t,e){var n=x.by(this,t);n.push(e),x.get(this).set(t,n)}},{key:"once",value:function(t,e){e.once=!0,this.on(t,e)}},{key:"off",value:function(t,e){if(t){var n=x.by(this,t);e||(n.length=0);var r=n.length>0&&n.findIndex((function(t){return t===e}));if(!(r>-1))throw new A("No listener found by function for event ".concat(t),{id:this.id,name:this.name});n.splice(r,1),x.get(this).set(t,n)}else x.get(this).clear()}},{key:"emit",value:function(t,e){for(var n=this,r=x.by(this,t).reverse(),o=function(){var t=r[i];E((function(){var r,o;(r=t,o=[e],new Promise((function(t,e){try{t(r.apply(void 0,w(o)))}catch(t){e(t)}}))).catch((function(t){return n.emit("error",{error:t,source:n})}))})),t.once&&r.splice(i,1)},i=r.length-1;i>=0;i--)o();x.get(this).set(t,r)}}]),t}(),A=function(t){c(n,l(Error));var e=s(n);function n(t,r){var o;return d(this,n),(o=e.call(this,t)).name="TinyflowError",o.details=r,o}return b(n)}(),T=function(t){var e=t.workflow,n=t.step,r=t.onSuccess,o=t.onError,i=e||n;Promise.all(Object.keys(i.custom).filter((function(t){return S.has(t)})).map((function(t){return S.get(t)(i.custom[t],{workflow:e,step:n})}))).then(r).catch(o)},M=function(t){c(r,I);var n=s(r);function r(t){var i,c=t.name,s=t.id,l=t.steps,f=void 0===l?{}:l,p=u(t,e);d(this,r),(i=n.call(this)).name=c,i.id=s||k.id(),i.data=null,i.state="pending",i.custom={},i.history=[];var h={};if(Object.entries(p).forEach((function(t){var e=a(t,2),n=e[0],r=e[1],o=a(Array.isArray(r)?r:[r,"all"],2),u=o[0],c=o[1];["all","workflow"].includes(c)&&(i.custom[n]=u),["all","steps"].includes(c)&&(h[n]=u)})),i.steps=Object.entries(f).map((function(t,e,n){var r=a(t,2),i=r[0],u=r[1];return o(o({next:e<n.length-1?e+1:null,name:i},h),u)})),0===i.steps.length)throw new A("Workflow steps must have at least one entry, got 0",{name:c,id:s});return i.current=null,i}return b(r,[{key:"start",value:function(){var t=this,e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).autoStep;if("active"===this.state)throw new A("Cannot start active workflow",{name:this.name,id:this.id});this.data=Object.create(null);var n=this;T({workflow:n,onSuccess:function(){t.state="active",t.emit("started",t),!1!==e&&t.step(0)},onError:function(e){return t.emit("error",{error:e,workflow:n})}})}},{key:"step",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=n.stepId,i=n.autoOnEnd;if("active"!==this.state)throw new A('Can only step in an active state, got "'.concat(this.state,'"'),{indexOrName:t,name:this.name,id:this.id});var a="number"==typeof t?this.steps[t]:this.steps.find((function(e){return e.name===t}));if(!a)throw new A("Expected step definition, got ".concat(a),{indexOrName:t,name:this.name,id:this.id});var u=r||k.id(),c=this.id,s=new _(o({id:u,workflowId:c},a)),l=this,f=function(t){return t&&(t.off(),e.history.push({name:t.name,data:o({},t.data),at:new Date})),!0};!1!==i&&s.once("end",(function(t){l.data[t.name]=o({},t.data);var e=t.next;return null!==e&&e<=l.steps.length-1?E((function(){return l.step(e)})):f(t)&&l.complete()})),s.start(),f(this.current),this.current=s,this.emit("step",this)}},{key:"complete",value:function(){this.current&&this.current.off(),this.current=null,this.state="complete",this.emit("end",this)}},{key:"cancel",value:function(){this.current&&this.current.off(),this.data=null,this.current=null,this.state="complete",this.emit("end",this)}}]),r}(),_=function(t){c(r,I);var e=s(r);function r(t){var o,i=t.id,a=t.workflowId,c=t.name,s=t.data,l=void 0===s?null:s,f=t.next,p=u(t,n);return d(this,r),(o=e.call(this)).id=i||k.id(),o.workflowId=a,o.name=c,o.next=f,o.custom=p,o.state="pending",o.data=l,o}return b(r,[{key:"start",value:function(){var t=this;if("active"===this.state)throw new A("Cannot start a step in active state",{name:this.name,id:this.id,wf:this.workflowId});this.data=this.data||Object.create(null);var e=this;T({step:e,onSuccess:function(){t.state="active",t.emit("started",t)},onError:function(n){return t.emit("error",{error:n,step:e})}})}},{key:"update",value:function(t){this.data=Object.create(null),Object.assign(this.data,t),this.emit("update",this)}},{key:"complete",value:function(){this.state="complete",this.emit("end",this)}},{key:"cancel",value:function(){this.state="cancelled",this.data=null,this.emit("end",this)}}]),r}();exports.Step=_,exports.Tinyflow=j,exports.Workflow=M;//# sourceMappingURL=Tinyflow.cjs.min.js.map
