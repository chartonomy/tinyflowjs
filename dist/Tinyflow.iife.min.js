var index=function(t){"use strict";function e(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function n(t){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?e(Object(r),!0).forEach((function(e){a(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):e(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,g(r.key),r)}}function i(t,e,n){return e&&o(t.prototype,e),n&&o(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function a(t,e,n){return(e=g(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function u(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&s(t,e)}function c(t){return c=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},c(t)}function s(t,e){return s=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},s(t,e)}function l(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function f(t,e,n){return f=l()?Reflect.construct.bind():function(t,e,n){var r=[null];r.push.apply(r,e);var o=new(Function.bind.apply(t,r));return n&&s(o,n.prototype),o},f.apply(null,arguments)}function h(t){var e="function"==typeof Map?new Map:void 0;return h=function(t){if(null===t||!function(t){try{return-1!==Function.toString.call(t).indexOf("[native code]")}catch(e){return"function"==typeof t}}(t))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,n)}function n(){return f(t,arguments,c(this).constructor)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),s(n,t)},h(t)}function p(t,e){if(null==t)return{};var n,r,o=function(t,e){if(null==t)return{};var n,r,o={},i=Object.keys(t);for(r=0;r<i.length;r++)n=i[r],e.indexOf(n)>=0||(o[n]=t[n]);return o}(t,e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(r=0;r<i.length;r++)n=i[r],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(o[n]=t[n])}return o}function d(t,e){if(e&&("object"==typeof e||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function y(t){var e=l();return function(){var n,r=c(t);if(e){var o=c(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return d(this,n)}}function v(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var r,o,i,a,u=[],c=!0,s=!1;try{if(i=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=i.call(n)).done)&&(u.push(r.value),u.length!==e);c=!0);}catch(t){s=!0,o=t}finally{try{if(!c&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(s)throw o}}return u}}(t,e)||m(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function b(t){return function(t){if(Array.isArray(t))return w(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||m(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function m(t,e){if(t){if("string"==typeof t)return w(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?w(t,e):void 0}}function w(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function g(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,e||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}var O=["name","id","steps"],j=["id","workflowId","name","data","next"],k={},S={extensions:new Map,instances:new Map,id:function(){return Math.random().toString(16).substring(2,16)},listeners:new WeakMap},P=S.extensions,x=S.listeners,E=S.instances;x.by=function(t,e){return x.has(t)||x.set(t,new Map),x.get(t).get(e)||[]},k.extend=function(t){return t(S)},k.get=function(t){return E.get(t)},k.all=function(){return b(E.values())},k.clear=function(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=function(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=m(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0,o=function(){};return{s:o,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,u=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return a=t.done,t},e:function(t){u=!0,i=t},f:function(){try{a||null==n.return||n.return()}finally{if(u)throw i}}}}(b(E.keys()));try{for(n.s();!(t=n.n()).done;){var r=t.value;k.get(r).cancel(),k.dispose(r)}}catch(t){n.e(t)}finally{n.f()}e.extensions&&P.clear()},k.use=function(t,e){(null===e?P.delete:P.set).call(P,t,e)},k.create=function(t){var e=new _(t);return E.set(e.id,e),e},k.dispose=function(t){var e=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).force,n=void 0!==e&&e,r=E.get(t);if(!r)throw new T("Workflow does not exist by id ".concat(t));if(!n&&"active"===r.state)throw new T('Cannot dispose active workflow "'.concat(r.name,'"'),{instanceId:t});r.current&&(r.current.off(),r.current=null),r.off(),x.delete(r),E.delete(t)};var I=function(t){return setTimeout(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:0)},A=function(){function t(){r(this,t)}return i(t,[{key:"count",value:function(){return x.by(this,name).length}},{key:"on",value:function(t,e){var n=x.by(this,t);n.push(e),x.get(this).set(t,n)}},{key:"once",value:function(t,e){e.once=!0,this.on(t,e)}},{key:"off",value:function(t,e){if(t){var n=x.by(this,t);e||(n.length=0);var r=n.length>0&&n.findIndex((function(t){return t===e}));if(!(r>-1))throw new T("No listener found by function for event ".concat(t),{id:this.id,name:this.name});n.splice(r,1),x.get(this).set(t,n)}else x.get(this).clear()}},{key:"emit",value:function(t,e){for(var n=this,r=x.by(this,t).reverse(),o=function(){var t=r[i];I((function(){var r,o;(r=t,o=[e],new Promise((function(t,e){try{t(r.apply(void 0,b(o)))}catch(t){e(t)}}))).catch((function(t){return n.emit("error",{error:t,source:n})}))})),t.once&&r.splice(i,1)},i=r.length-1;i>=0;i--)o();x.get(this).set(t,r)}}]),t}(),T=function(t){u(n,t);var e=y(n);function n(t,o){var i;return r(this,n),(i=e.call(this,t)).name="TinyflowError",i.details=o,i}return i(n)}(h(Error)),M=function(t){var e=t.workflow,n=t.step,r=t.onSuccess,o=t.onError,i=e||n;Promise.all(Object.keys(i.custom).filter((function(t){return P.has(t)})).map((function(t){return P.get(t)(i.custom[t],{workflow:e,step:n})}))).then(r).catch(o)},_=function(t){u(o,t);var e=y(o);function o(t){var i,a=t.name,u=t.id,c=t.steps,s=void 0===c?{}:c,l=p(t,O);r(this,o),(i=e.call(this)).name=a,i.id=u||S.id(),i.data=null,i.state="pending",i.custom={},i.history=[];var f={};if(Object.entries(l).forEach((function(t){var e=v(t,2),n=e[0],r=e[1],o=v(Array.isArray(r)?r:[r,"all"],2),a=o[0],u=o[1];["all","workflow"].includes(u)&&(i.custom[n]=a),["all","steps"].includes(u)&&(f[n]=a)})),i.steps=Object.entries(s).map((function(t,e,r){var o=v(t,2),i=o[0],a=o[1];return n(n({next:e<r.length-1?e+1:null,name:i},f),a)})),0===i.steps.length)throw new T("Workflow steps must have at least one entry, got 0",{name:a,id:u});return i.current=null,i}return i(o,[{key:"start",value:function(){var t=this,e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).autoStep;if("active"===this.state)throw new T("Cannot start active workflow",{name:this.name,id:this.id});this.data=Object.create(null);var n=this;M({workflow:n,onSuccess:function(){t.state="active",t.emit("started",t),!1!==e&&t.step(0)},onError:function(e){return t.emit("error",{error:e,workflow:n})}})}},{key:"step",value:function(t){var e=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=r.stepId,i=r.autoOnEnd;if("active"!==this.state)throw new T('Can only step in an active state, got "'.concat(this.state,'"'),{indexOrName:t,name:this.name,id:this.id});var a="number"==typeof t?this.steps[t]:this.steps.find((function(e){return e.name===t}));if(!a)throw new T("Expected step definition, got ".concat(a),{indexOrName:t,name:this.name,id:this.id});var u=o||S.id(),c=this.id,s=new R(n({id:u,workflowId:c},a)),l=this,f=function(t){return t&&(t.off(),e.history.push({name:t.name,data:n({},t.data),at:new Date})),!0};!1!==i&&s.once("end",(function(t){l.data[t.name]=n({},t.data);var e=t.next;return null!==e&&e<=l.steps.length-1?I((function(){return l.step(e)})):f(t)&&l.complete()})),s.start(),f(this.current),this.current=s,this.emit("step",this)}},{key:"complete",value:function(){this.current&&this.current.off(),this.current=null,this.state="complete",this.emit("end",this)}},{key:"cancel",value:function(){this.current&&this.current.off(),this.data=null,this.current=null,this.state="complete",this.emit("end",this)}}]),o}(A),R=function(t){u(n,t);var e=y(n);function n(t){var o,i=t.id,a=t.workflowId,u=t.name,c=t.data,s=void 0===c?null:c,l=t.next,f=p(t,j);return r(this,n),(o=e.call(this)).id=i||S.id(),o.workflowId=a,o.name=u,o.next=l,o.custom=f,o.state="pending",o.data=s,o}return i(n,[{key:"start",value:function(){var t=this;if("active"===this.state)throw new T("Cannot start a step in active state",{name:this.name,id:this.id,wf:this.workflowId});this.data=this.data||Object.create(null);var e=this;M({step:e,onSuccess:function(){t.state="active",t.emit("started",t)},onError:function(n){return t.emit("error",{error:n,step:e})}})}},{key:"update",value:function(t){this.data=Object.create(null),Object.assign(this.data,t),this.emit("update",this)}},{key:"complete",value:function(){this.state="complete",this.emit("end",this)}},{key:"cancel",value:function(){this.state="cancelled",this.data=null,this.emit("end",this)}}]),n}(A);return t.Step=R,t.Tinyflow=k,t.Workflow=_,t}({});//# sourceMappingURL=Tinyflow.iife.min.js.map
